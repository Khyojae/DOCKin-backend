<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DOCKin Chat - Realtime System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        :root { --main-color: #0d6efd; --bg-light: #f8f9fa; }
        body { background-color: #f0f2f5; font-family: 'Pretendard', sans-serif; }
        .room-item { cursor: pointer; border-bottom: 1px solid #f1f1f1; transition: all 0.2s; background: white; }
        .room-item:hover { background-color: #f8f9fa; }
        .room-item.active { background-color: #eef5ff !important; border-left: 4px solid var(--main-color); }
        .unread-badge {
            background-color: #ff3b30; color: white; border-radius: 50%;
            padding: 2px 6px; font-size: 0.75rem; font-weight: bold;
            min-width: 18px; text-align: center; display: inline-block;
        }
        #messageBox { background-color: #f1f3f5; height: 550px; overflow-y: auto; display: flex; flex-direction: column; }
        .msg-container { margin-bottom: 12px; max-width: 80%; }
        .msg-bubble { border-radius: 15px; padding: 10px 15px; position: relative; font-size: 0.95rem; }
        .my-msg { align-self: flex-end; }
        .other-msg { align-self: flex-start; }
        .new-msg-anim { animation: highlight 1.2s ease; }
        @keyframes highlight { 0% { background-color: #fff9c4; } 100% { background-color: white; } }
    </style>

    <script type="text/javascript">
        let stompClient;
        let subscriptions = {};
        let currentRoomId = null;
        let currentUserId = "";
        const SERVER_URL = "http://localhost:8080";

        function connect() {
            const jwtToken = $('#jwtToken').val();
            const inputUserId = $('#inputUserId').val();

            if (!jwtToken || !inputUserId) return alert("사번과 토큰을 입력하세요.");
            currentUserId = inputUserId;

            if (stompClient) stompClient.disconnect();
            axios.defaults.headers.common['Authorization'] = 'Bearer ' + jwtToken;

            // [중요] WebSocket 엔드포인트가 /ws 인지 확인하세요
            stompClient = Stomp.client("ws://localhost:8080/ws");
            stompClient.connect({'token': jwtToken}, () => {
                alert(currentUserId + ' 연결 성공!');

                // 내 알림 구독
                stompClient.subscribe(`/sub/user/${currentUserId}/rooms`, (data) => {
                    handleListUpdate(JSON.parse(data.body));
                });

                loadMyRooms();
            }, (e) => alert('연결 실패: ' + e));
        }

        function handleListUpdate(msg) {
            const roomId = msg.roomId;
            const content = msg.content;
            const roomElem = $(`#room-${roomId}`);

            if (roomElem.length > 0) {
                roomElem.find('.last-msg').text(content);
                $('#roomList').prepend(roomElem);
                if (currentRoomId !== roomId) {
                    const badge = roomElem.find('.unread-badge');
                    let count = parseInt(badge.text()) || 0;
                    badge.text(count + 1).show();
                }
                roomElem.addClass('new-msg-anim');
                setTimeout(() => roomElem.removeClass('new-msg-anim'), 1200);
            } else {
                loadMyRooms();
            }
        }

        function loadMyRooms() {
            // [수정] 백엔드 DTO 필드명에 맞춰 rId = room.roomId 등으로 변경
            axios.get(`${SERVER_URL}/api/chat/rooms`)
                .then(res => {
                    const rooms = res.data.content; // Page 객체 대응
                    const list = $('#roomList').empty();
                    rooms.forEach(room => {
                        const rId = room.roomId;
                        const rName = room.roomName;
                        const lastMsg = room.lastMessageContent || '대화 내역이 없습니다.';
                        const activeClass = (currentRoomId === rId) ? 'active' : '';
                        const unreadCount = room.unreadCount || 0;
                        const badgeStyle = unreadCount > 0 ? '' : 'display: none;';

                        const html = `
                            <div class="room-item p-3 ${activeClass}" onclick="enterRoom(${rId}, '${rName}')" id="room-${rId}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <div class="flex-grow-1 overflow-hidden">
                                        <strong class="text-dark d-block text-truncate">${rName}</strong>
                                        <div class="small text-muted text-truncate mt-1 last-msg">${lastMsg}</div>
                                    </div>
                                    <div class="text-end ms-2">
                                        <span class="unread-badge mb-1" style="${badgeStyle}">${unreadCount}</span>
                                        <div class="badge bg-light text-secondary border-0 small">${room.isGroup ? '그룹' : '1:1'}</div>
                                    </div>
                                </div>
                            </div>`;
                        list.append(html);
                    });
                }).catch(e => console.error("목록 로딩 실패:", e));
        }

        function enterRoom(roomId, roomName) {
            if (subscriptions['chat']) subscriptions['chat'].unsubscribe();

            currentRoomId = roomId;
            $('.room-item').removeClass('active');
            $(`#room-${roomId}`).addClass('active').find('.unread-badge').text('0').hide();

            $('#currentRoomTitle').text(roomName);
            $('#messageBox').empty();

            // 읽음 처리 업데이트 API 호출
            axios.get(`${SERVER_URL}/api/chat/room/${roomId}`)
                .then(() => {
                    subscriptions['chat'] = stompClient.subscribe(`/sub/chat/room/${roomId}`, (data) => {
                        displayMessage(JSON.parse(data.body));
                    });
                    loadMessages(roomId);
                });
        }

        function loadMessages(roomId) {
            axios.get(`${SERVER_URL}/api/chat/room/${roomId}/messages`)
                .then(res => {
                    const history = res.data.content;
                    if(history) history.reverse().forEach(msg => displayMessage(msg));
                });
        }

        function sendMessage() {
            const content = $('#messageInput').val();
            if (!currentRoomId || !content.trim()) return;

            const payload = {
                roomId: currentRoomId,
                senderId: currentUserId,
                content: content,
                messageType: "TEXT"
            };

            stompClient.send("/pub/chat/message", {}, JSON.stringify(payload));
            $('#messageInput').val('');
        }

        function displayMessage(data) {
            const isMe = data.senderId == currentUserId;
            const containerClass = isMe ? 'my-msg' : 'other-msg';
            const bubbleClass = isMe ? 'bg-primary text-white' : 'bg-white text-dark border';

            const html = `
                <div class="msg-container ${containerClass}">
                    <div class="small text-muted mb-1 px-2">${isMe ? '나' : data.senderId}</div>
                    <div class="msg-bubble ${bubbleClass} shadow-sm">
                        ${data.content}
                    </div>
                </div>`;
            $('#messageBox').append(html);
            $('#messageBox').scrollTop($('#messageBox')[0].scrollHeight);
        }

        $(function() {
            $('#messageInput').keypress(e => { if(e.which == 13) sendMessage(); });
        });
    </script>
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="card shadow border-0" style="border-radius: 15px; overflow: hidden; max-width: 1000px; margin: 0 auto;">
        <div class="row g-0">
            <div class="col-md-4 border-end bg-white" style="height: 800px; display: flex; flex-direction: column;">
                <div class="p-3 bg-primary text-white d-flex align-items-center">
                    <i class="bi bi-chat-dots-fill fs-4 me-2"></i>
                    <h5 class="mb-0 fw-bold">DOCKin Messenger</h5>
                </div>
                <div class="p-3 border-bottom bg-light">
                    <div class="row g-2">
                        <div class="col-4">
                            <input type="text" id="inputUserId" class="form-control form-control-sm" placeholder="내 사번">
                        </div>
                        <div class="col-8">
                            <input type="password" id="jwtToken" class="form-control form-control-sm" placeholder="JWT Token">
                        </div>
                    </div>
                    <button class="btn btn-dark btn-sm w-100 mt-2 fw-bold" onclick="connect()">접속</button>
                </div>
                <div id="roomList" class="overflow-auto flex-grow-1"></div>
            </div>

            <div class="col-md-8 d-flex flex-column" style="height: 800px; background: #f1f3f5;">
                <div class="p-3 border-bottom bg-white shadow-sm d-flex justify-content-between align-items-center">
                    <h6 id="currentRoomTitle" class="mb-0 fw-bold text-dark">채팅방을 선택하세요</h6>
                </div>
                <div id="messageBox" class="flex-grow-1 p-4"></div>
                <div class="p-3 bg-white border-top">
                    <div class="input-group shadow-sm">
                        <input type="text" id="messageInput" class="form-control border-0 bg-light" placeholder="메시지를 입력하세요..." style="padding: 12px;">
                        <button class="btn btn-primary px-4" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>