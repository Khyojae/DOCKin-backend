<!doctype html>
<html lang="ko">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>DOCKin Messenger Test Final (Fixed)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <style>
        .room-item { cursor: pointer; border-bottom: 1px solid #eee; transition: background 0.2s; }
        .room-item:hover { background-color: #f8f9fa; }
        .room-item.active { background-color: #e9ecef; border-left: 5px solid #0d6efd; }
        #messageBox { background-color: #f1f3f5; border-radius: 10px; box-shadow: inset 0 0 5px rgba(0,0,0,0.1); }
        .msg-time { font-size: 0.7rem; color: #888; display: block; margin-top: 2px; }
        .alert { border-radius: 15px; border: none !important; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #ccc; border-radius: 10px; }
    </style>

    <script type="text/javascript">
        let stompClient;
        let subscriptions = {};
        let currentRoomId = null;
        const SERVER_URL = "http://localhost:8080";

        // 1. ì„œë²„ ì—°ê²° ë° JWT ì„¤ì •
        function connect() {
            const url = $('#websocketUrl').val();
            const jwtToken = $('#jwtToken').val();
            if (!jwtToken) return alert("JWT í† í°ì„ ì…ë ¥í•˜ì„¸ìš”.");

            axios.defaults.headers.common['Authorization'] = 'Bearer ' + jwtToken;

            stompClient = Stomp.client(url);
            stompClient.connect({'token': jwtToken}, () => {
                alert('ì—°ê²° ì„±ê³µ!');
                loadMyRooms();
            }, (e) => alert('ì—°ê²° ì‹¤íŒ¨: ' + e));
        }

        // 2. ë‚´ ì±„íŒ…ë°© ëª©ë¡ ë¡œë“œ
        function loadMyRooms() {
            axios.get(`${SERVER_URL}/api/chat/rooms`)
                .then(res => {
                    const rooms = res.data.content;
                    const list = $('#roomList').empty();
                    if(!rooms || rooms.length === 0) {
                        list.append('<div class="text-center p-5 text-muted">ì°¸ì—¬ ì¤‘ì¸ ë°©ì´ ì—†ìŠµë‹ˆë‹¤.</div>');
                        return;
                    }
                    rooms.forEach(room => {
                        const rId = room.room_Id;
                        const rName = room.room_name;
                        const lastMsg = room.lastMessageContent || 'ëŒ€í™” ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.';
                        const html = `
                            <div class="room-item p-3" onclick="enterRoom(${rId}, '${rName}')" id="room-${rId}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <strong class="text-primary">${rName}</strong>
                                    <span class="badge bg-light text-dark border">${room.is_group ? 'ê·¸ë£¹' : '1:1'}</span>
                                </div>
                                <div class="text-truncate small text-muted mt-1">${lastMsg}</div>
                            </div>`;
                        list.append(html);
                    });
                }).catch(e => alert("ë°© ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨: " + e));
        }

        // 3. ì±„íŒ…ë°© ì…ì¥ ë° ë‚´ì—­ ë¡œë“œ
        function enterRoom(roomId, roomName) {
            currentRoomId = roomId;
            $('#searchKeyword').val('');
            $('.room-item').removeClass('active');
            $(`#room-${roomId}`).addClass('active');
            $('#currentRoomTitle').text(roomName);
            $('#messageBox').empty();
            $('#chatHeaderActions').show();

            Object.keys(subscriptions).forEach(path => {
                subscriptions[path].unsubscribe();
                delete subscriptions[path];
            });

            const subPath = `/sub/chat/room/${roomId}`;
            subscriptions[subPath] = stompClient.subscribe(subPath, (data) => {
                displayMessage(data.body, false);
            });

            loadMessages(roomId);
        }

        function loadMessages(roomId) {
            if(!roomId) return;
            axios.get(`${SERVER_URL}/api/chat/room/${roomId}/messages`)
                .then(res => {
                    const history = res.data.content;
                    $('#messageBox').empty();
                    if(history && history.length > 0) {
                        history.reverse().forEach(msg => displayMessage(msg, true));
                    } else {
                        $('#messageBox').append('<div class="text-center text-muted my-5">ì´ì „ ëŒ€í™”ê°€ ì—†ìŠµë‹ˆë‹¤.</div>');
                    }
                }).catch(e => console.error("ë‚´ì—­ ë¡œë“œ ì‹¤íŒ¨", e));
        }

        // 4. ì±„íŒ…ë°© ë‚˜ê°€ê¸°
        function leaveRoom() {
            if(!currentRoomId) return;
            if(!confirm("ì •ë§ ì´ ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            axios.delete(`${SERVER_URL}/api/chat/room/leave/${currentRoomId}`)
                .then(res => {
                    alert("ë°©ì—ì„œ ë‚˜ê°”ìŠµë‹ˆë‹¤.");
                    const subPath = `/sub/chat/room/${currentRoomId}`;
                    if(subscriptions[subPath]) {
                        subscriptions[subPath].unsubscribe();
                        delete subscriptions[subPath];
                    }
                    currentRoomId = null;
                    $('#currentRoomTitle').text("ë°©ì„ ì„ íƒí•˜ì„¸ìš”");
                    $('#messageBox').empty();
                    $('#chatHeaderActions').hide();
                    loadMyRooms();
                }).catch(e => alert("ë°© ë‚˜ê°€ê¸° ì‹¤íŒ¨"));
        }

        // 5. ë©”ì‹œì§€ ê²€ìƒ‰
        function searchMessages() {
            const keyword = $('#searchKeyword').val();
            if (!currentRoomId) return alert("ë°©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.");
            if (!keyword) return loadMessages(currentRoomId);

            axios.get(`${SERVER_URL}/api/chat/room/${currentRoomId}/messages/search`, {
                params: { keyword: keyword }
            })
                .then(res => {
                    const results = res.data.content;
                    $('#messageBox').empty();
                    $('#messageBox').append(`<div class="text-center small text-primary fw-bold my-3">ğŸ” '${keyword}' ê²€ìƒ‰ ê²°ê³¼ (${results.length}ê±´)</div>`);
                    results.forEach(msg => displayMessage(msg, true));
                }).catch(e => alert("ê²€ìƒ‰ ì‹¤íŒ¨"));
        }

        // 6. ë©”ì‹œì§€ ì „ì†¡ (DTO ì–‘ì‹ ì¤€ìˆ˜)
        function sendMessage() {
            const content = $('#messageInput').val();
            if (!currentRoomId || !content) return;

            // ChatMessageRequestDto ì–‘ì‹ì— ë§ì¶˜ ë°ì´í„°
            const payload = {
                roomId: currentRoomId,
                senderId: "1001", // í…ŒìŠ¤íŠ¸ìš© ì‚¬ë²ˆ (ì‹¤ì œ ë¡œê·¸ì¸ ìœ ì € ì •ë³´ë¡œ ë³€ê²½ í•„ìš”)
                content: content,
                messageType: "TEXT", // í•„ìˆ˜ ê°’
                fileUrl: ""
            };

            stompClient.send("/pub/chat/message", {}, JSON.stringify(payload));
            $('#messageInput').val('');
        }

        // 7. ë©”ì‹œì§€ í‘œì‹œ (í•„ë“œ ë§¤ì¹­ ìˆ˜ì •)
        function displayMessage(raw, isHistory) {
            let data;
            try {
                // ì´ë¯¸ ê°ì²´ë©´ ê·¸ëŒ€ë¡œ, ë¬¸ìì—´ì´ë©´ JSON íŒŒì‹±
                data = (typeof raw === 'string') ? JSON.parse(raw) : raw;
            } catch(e) {
                data = { senderId: 'System', content: raw };
            }

            // DOCKin ë°±ì—”ë“œ í•„ë“œëª…ì— ë§ì¶° ë§¤ì¹­ (senderId, content, sentAt ë“±)
            const sender = data.senderId || 'ì•Œ ìˆ˜ ì—†ìŒ';
            const content = data.content || 'ë‚´ìš© ì—†ìŒ';
            const time = data.sentAt || '';

            const alertClass = isHistory ? 'alert-secondary text-muted' : 'alert-info shadow-sm';
            const html = `
                <div class="mb-3 px-2 text-start">
                    <div class="alert ${alertClass} d-inline-block py-2 px-3 mb-0" style="max-width: 85%;">
                        <b style="font-size:0.75rem; display:block; margin-bottom:2px; color:#555;">${sender}</b>
                        <span style="font-size:0.95rem;">${content}</span>
                    </div>
                    <span class="msg-time px-1">${time}</span>
                </div>`;
            $('#messageBox').append(html);
            $('#messageBox').scrollTop($('#messageBox')[0].scrollHeight);
        }

        $(function() {
            $('#messageInput').keypress(e => { if(e.which == 13) sendMessage(); });
            $('#searchKeyword').keypress(e => { if(e.which == 13) searchMessages(); });
            $('#chatHeaderActions').hide();
        });
    </script>
</head>
<body class="bg-light">
<div class="container py-4">
    <div class="card shadow-lg border-0 overflow-hidden" style="border-radius: 15px;">
        <div class="card-body p-0">
            <div class="row g-0">
                <div class="col-md-4 border-end" style="height: 800px; display: flex; flex-direction: column; background: white;">
                    <div class="p-4 bg-primary text-white">
                        <h5 class="mb-0 fw-bold"><i class="bi bi-chat-dots-fill me-2"></i>DOCKin Chat</h5>
                    </div>
                    <div class="p-3 border-bottom bg-light">
                        <label class="small fw-bold text-muted mb-1">JWT ì¸ì¦ í† í°</label>
                        <textarea id="jwtToken" class="form-control form-control-sm mb-2" rows="2" placeholder="Bearer ì œì™¸ ì…ë ¥"></textarea>
                        <button class="btn btn-dark btn-sm w-100 fw-bold" onclick="connect()">ì„œë²„ ì—°ê²° ë° ë¡œê·¸ì¸</button>
                        <input type="hidden" id="websocketUrl" value="ws://localhost:8080/ws">
                    </div>
                    <div id="roomList" class="overflow-auto flex-grow-1"></div>
                </div>

                <div class="col-md-8 d-flex flex-column" style="height: 800px; background: #fdfdfd;">
                    <div class="p-3 border-bottom bg-white shadow-sm" style="z-index: 10;">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h6 id="currentRoomTitle" class="mb-0 fw-bold text-dark">ë°©ì„ ì„ íƒí•˜ì„¸ìš”</h6>
                            <div id="chatHeaderActions">
                                <button class="btn btn-sm btn-outline-danger border-0 fw-bold me-2" onclick="leaveRoom()">
                                    <i class="bi bi-box-arrow-right"></i> ë‚˜ê°€ê¸°
                                </button>
                                <button class="btn btn-sm btn-outline-secondary border-0" onclick="loadMyRooms()">
                                    <i class="bi bi-arrow-clockwise"></i>
                                </button>
                            </div>
                        </div>
                        <div class="input-group input-group-sm">
                            <span class="input-group-text bg-light border-0"><i class="bi bi-search"></i></span>
                            <input type="text" id="searchKeyword" class="form-control border-0 bg-light" placeholder="ì±„íŒ… ë‚´ìš© ê²€ìƒ‰ (Enter)">
                            <button class="btn btn-outline-primary border-0 fw-bold" onclick="searchMessages()">ê²€ìƒ‰</button>
                            <button class="btn btn-outline-danger border-0 fw-bold" onclick="loadMessages(currentRoomId)">ì·¨ì†Œ</button>
                        </div>
                    </div>

                    <div id="messageBox" class="flex-grow-1 p-4 overflow-auto"></div>

                    <div class="p-3 bg-white border-top">
                        <div class="input-group overflow-hidden" style="border-radius: 30px; background: #f1f3f5;">
                            <input type="text" id="messageInput" class="form-control border-0 bg-transparent px-4" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." style="height: 50px;">
                            <button class="btn btn-primary px-4" onclick="sendMessage()"><i class="bi bi-send-fill"></i></button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>